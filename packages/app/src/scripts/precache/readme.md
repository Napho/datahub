TODO: re-write this in JS